name: Daily run (scanner + trend) and notify (email only)

on:
  schedule:
    # Daily at 03:15 UTC (08:45 IST)
    - cron: '15 3 * * *'
  workflow_dispatch: {}

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system deps (for TA-Lib)
        # TA-Lib needs a C library. Install dev package before pip.
        run: |
          sudo apt-get update
          # libta-lib-dev provides headers/libraries for TA-Lib
          sudo apt-get install -y build-essential libta-lib0 libta-lib-dev

      - name: Install Python dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run scanner.py and trend.py, capture outputs
        id: run
        run: |
          set -x
          python scanner.py > scanner_output.txt 2>&1 || true
          python trend.py   > trend_output.txt   2>&1 || true

          echo "=== scanner.py output ===" > final_output.txt
          cat scanner_output.txt >> final_output.txt
          echo -e "\n\n=== trend.py output ===" >> final_output.txt
          cat trend_output.txt >> final_output.txt

          # expose multiline output to later steps
          echo "OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat final_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload output artifact (optional, for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: daily-script-output
          path: |
            scanner_output.txt
            trend_output.txt
            final_output.txt

      - name: Send email (Gmail SMTP) (if secrets set)
        if: ${{ secrets.EMAIL_USER && secrets.EMAIL_APP_PASSWORD }}
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_APP_PASSWORD }}
          OUTPUT: ${{ steps.run.outputs.OUTPUT }}
        run: |
          python - <<'PY'
          import os, smtplib
          from email.message import EmailMessage
          out = os.environ.get('OUTPUT','(no output)')
          msg = EmailMessage()
          msg['Subject'] = 'Daily: scanner.py + trend.py output'
          msg['From'] = os.environ['EMAIL_USER']
          msg['To'] = os.environ['EMAIL_USER']
          short = out.splitlines()[:25]
          msg.set_content("Attached: combined script output.\n\nPreview:\n" + "\n".join(short))
          msg.add_attachment(out, filename="daily_output.txt")
          with smtplib.SMTP_SSL('smtp.gmail.com', 465) as s:
              s.login(os.environ['EMAIL_USER'], os.environ['EMAIL_PASS'])
              s.send_message(msg)
          print("Email sent")
          PY

      - name: Show run summary
        run: |
          echo "Workflow finished. Artifact and email steps ran (if secrets provided)."
